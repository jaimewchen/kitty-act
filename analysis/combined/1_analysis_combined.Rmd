---
title: "Combined Analysis - Kitty Act V1/ V1a"
author: "Martin Zettersten"
date: "2025-01-20"
output: html_document
---

```{r setup, warning=FALSE, message=F}
library(here)
library(tidyverse)
library(ggplot2)
library(viridisLite)
library(lme4)
library(ggstance)
library(cowplot)
library(AICcmodavg)
library(RColorBrewer)
library(jsonlite)
library(tidyjson)
library(rlang)
library(car)
library(nnet)
library(mlogit)
library(lmerTest)
library(assertthat)
library(knitr)
library(patchwork)
library(ggpattern)
source("helper.R")
```

# Read and combine child and adult data

## Read in Adult Data

```{r, warning=FALSE, message=F}
adult_data_path <- here("..","v1a","data","processed", "kitty-act_v1a-alldata-processed.csv")
adult_sampling_data_path <- here("..","v1a","data","processed", "kitty-act_v1a-sampling-data.csv")
adult_test_data_path <- here("..","v1a","data","processed", "kitty-act_v1a-test-data.csv")
adult_test_data_long_path <- here("..","v1a","data","processed", "kitty-act_v1a-test-data-long.csv")
write_path <- here("processed_data")
figure_path <- here("figures")

adult_d <- read_csv(adult_data_path) %>%
  mutate(number_training_images_order = case_when(
    number_training_image_order_vector == "[1,3]" ~ "One-Three",
    number_training_image_order_vector == "[3,1]" ~ "Three-One",
  )) %>%
  mutate(
    sample_group = "adults"
  ) %>%
  rename(participant=subject) %>%
  #apply exclusions
  filter(exclude_participant==0)
adult_sampling_data <- read_csv(adult_sampling_data_path) %>%
  mutate(number_training_image_order = case_when(
    number_training_image_order_vector == "[1,3]" ~ "One-Three",
    number_training_image_order_vector == "[3,1]" ~ "Three-One",
  )) %>%
  mutate(
    sample_group = "adults"
  )%>%
  rename(participant=subject)%>%
  mutate(
    round = case_when(
      trial_number %in% c(1,2,3) ~ 1,
      trial_number %in% c(4,5,6) ~ 2)
  ) %>%
  mutate(
    trial_counter=trial_number
  ) %>%
  #apply exclusions
  filter(exclude_participant==0)
adult_test_array_clean <- read_csv(adult_test_data_path) %>%
  mutate(number_training_image_order_vector = case_when(
    number_training_image_order_vector == "[1,3]" ~ "One-Three",
    number_training_image_order_vector == "[3,1]" ~ "Three-One",
  )) %>%
  mutate(
    sample_group = "adults"
  )%>%
  rename(participant=subject) %>%
  mutate(
    round = case_when(
      trial_number %in% c(1,2,3) ~ 1,
      trial_number %in% c(4,5,6) ~ 2)
  ) %>%
  #apply exclusions
  filter(exclude_participant==0)
adult_test_array_options_clean <- read_csv(adult_test_data_long_path) %>%
  mutate(number_training_images_order = case_when(
    number_training_image_order_vector == "[1,3]" ~ "One-Three",
    number_training_image_order_vector == "[3,1]" ~ "Three-One",
  )) %>%
  mutate(
    sample_group = "adults"
  )%>%
  rename(participant=subject) %>%
  mutate(
    round = case_when(
      trial_number %in% c(1,2,3) ~ 1,
      trial_number %in% c(4,5,6) ~ 2)
  ) %>%
  #apply exclusions
  filter(exclude_participant==0)
```

## Read in Child Data

```{r}
kid_data_path <- here("..","v1","processed_data", "kitty-act-v1-alldata.csv")
kid_sampling_data_path <- here("..","v1","processed_data", "kitty-act-v1-processed_data_sampling.csv")
kid_test_data_path <- here("..","v1","processed_data", "kitty-act-v1-processed_data.csv")
kid_test_data_long_path <- here("..","v1","processed_data", "kitty-act-v1-processed_data_long.csv")
kid_participant_info_path <- here("..","v1","processed_data","kitty-act-v1-participant_info.csv")

kid_d <- read_csv(kid_data_path) %>%
  mutate(number_training_images_order = case_when(
    number_training_image_order_vector == "[1,3]" ~ "One-Three",
    number_training_image_order_vector == "[3,1]" ~ "Three-One",
  )) %>%
  mutate(
    sample_group = "children"
  )
kid_sampling_data <- read_csv(kid_sampling_data_path) %>%
  mutate(number_training_images_order = case_when(
    number_training_image_order_vector == "[1,3]" ~ "One-Three",
    number_training_image_order_vector == "[3,1]" ~ "Three-One",
  ))  %>%
  mutate(
    sample_group = "children"
  )
kid_test_array_clean <- read_csv(kid_test_data_path) %>%
  mutate(number_training_images_order = case_when(
    number_training_image_order_vector == "[1,3]" ~ "One-Three",
    number_training_image_order_vector == "[3,1]" ~ "Three-One",
  ))  %>%
  mutate(
    sample_group = "children"
  )
kid_test_array_options_clean <- read_csv(kid_test_data_long_path) %>%
  mutate(number_training_images_order = case_when(
    number_training_image_order_vector == "[1,3]" ~ "One-Three",
    number_training_image_order_vector == "[3,1]" ~ "Three-One",
  ))  %>%
  mutate(
    sample_group = "children"
  )
#participant info
kid_participant_info <- read_csv(kid_participant_info_path) %>%
  filter(pilot == "no")  %>%
  mutate(post_correction=ifelse(experiment_version=="exp_v1.1",1,0)) %>%
  mutate(
    sample_group = "children"
  )
```

## compute ages and integrate with main data

```{r}
kid_participant_info$age_mos_int <- kid_participant_info$age_mos

kid_participant_info <- kid_participant_info %>%
  mutate(resid_month_decimal=age_day_count/30.417) %>%
  mutate(age_mos = age_mos_int+resid_month_decimal,
         age_years=age_mos/12) %>%
  mutate(
    age_years_c=age_years-mean(age_years)
  )

average_age <- kid_participant_info %>%
  summarize(
    N=n(),
    mean_age=mean(age_years,na.rm=TRUE),
    sd_age=sd(age_years,na.rm=TRUE),
    min_age=min(age_years,na.rm=TRUE),
    max_age=max(age_years,na.rm=TRUE)
  )

average_age %>%
  kable()

#check that integration will work
#all subject ids in the response data and the participant info are shared
setdiff(unique(kid_d$subject_id),unique(kid_participant_info$subject_id))
setdiff(unique(kid_participant_info$subject_id),unique(kid_d$subject_id))

kid_d <- kid_d %>%
  left_join(select(kid_participant_info,subject_id,age_group,age_mos,age_years,age_years_c,pilot,exclude, post_correction)) %>%
  #convert rt to numeric
  mutate(
    rt = case_when(
      rt=="null" ~ NA,
      TRUE ~ as.numeric(rt)
    )
  )%>%
  mutate(exclude_participant = case_when(
    exclude == "yes" ~ 1,
    exclude == "no" ~ 0,
    TRUE ~ 0
  ))# %>%
  # filter(
  #   post_correction == 1
  # )
kid_sampling_data <- kid_sampling_data %>%
  left_join(select(kid_participant_info,subject_id,age_group,age_mos,age_years,age_years_c,pilot,exclude,post_correction))%>%
  mutate(exclude_participant = case_when(
    exclude == "yes" ~ 1,
    exclude == "no" ~ 0,
    TRUE ~ 0
  )) #%>%
  # filter(
  #   post_correction == 1
  # )
kid_test_array_clean <- kid_test_array_clean %>%
  left_join(select(kid_participant_info,subject_id,age_group,age_mos,age_years,age_years_c,pilot,exclude,post_correction))%>%
  mutate(exclude_participant = case_when(
    exclude == "yes" ~ 1,
    exclude == "no" ~ 0,
    TRUE ~ 0
  ))# %>%
  # filter(
  #   post_correction == 1
  # )
kid_test_array_options_clean <- kid_test_array_options_clean %>%
  left_join(select(kid_participant_info,subject_id,age_group,age_mos,age_years,age_years_c,pilot,exclude,post_correction))%>%
  mutate(exclude_participant = case_when(
    exclude == "yes" ~ 1,
    exclude == "no" ~ 0,
    TRUE ~ 0
  )) #%>%
  # filter(
  #   post_correction == 1
  # )
```

## combine child and adult data

```{r}
# combine data sets

#first check overlap in columns
setdiff(colnames(kid_d),colnames(adult_d))
setdiff(colnames(adult_d),colnames(kid_d))

#combined
combined_d <- kid_d %>%
  bind_rows(adult_d)

combined_sampling_data <- kid_sampling_data %>%
  bind_rows(adult_sampling_data)

combined_test_array_clean <- kid_test_array_clean %>%
  bind_rows(adult_test_array_clean)

combined_test_array_options_clean <- kid_test_array_options_clean %>%
  bind_rows(adult_test_array_options_clean)
```

# Summarize Test Data

```{r}
## shorter test representation
subj_test_accuracy <- combined_test_array_clean %>%
  group_by(sample_group,participant,age_years,age_years_c,number_training_images,round,trial_counter,trial_type,current_category_training_level,current_category_label_level,current_category_kind,final_choice_array,total_number_correct_options) %>%
  summarize(
    total_choices = n(),
    ground_truth_correct_choices = sum(test_choice_type_label_consistent),
    ground_truth_incorrect_choices = sum(test_choice_type_label_consistent==0),
    training_consistent_choices = sum(test_choice_type_training_consistent),
    training_inconsistent_choices = sum(test_choice_type_training_consistent==0),
    training_category_match_subordinate_choices = sum(test_choice_match_category==1 & test_choice_type == "subordinate"),
    training_category_match_basic_choices = sum(test_choice_match_category==1 & test_choice_type == "basic"),
    training_category_match_superordinate_choices = sum(test_choice_match_category==1 & test_choice_type == "superordinate"),
    training_category_match_subordinate_percent = training_category_match_subordinate_choices,
    training_category_match_basic_percent = training_category_match_basic_choices,
    training_category_match_superordinate_percent = training_category_match_superordinate_choices/2
  )

subj_test_accuracy_long <- subj_test_accuracy %>%
  select(sample_group,participant,age_years,age_years_c,number_training_images,round,trial_counter,trial_type,current_category_training_level,current_category_label_level,current_category_kind,final_choice_array,total_number_correct_options,training_category_match_subordinate_percent,training_category_match_basic_percent,training_category_match_superordinate_percent) %>%
  group_by(participant,number_training_images,round,trial_counter,trial_type,current_category_training_level,current_category_label_level,current_category_kind,final_choice_array,total_number_correct_options) %>%
  pivot_longer(cols=training_category_match_subordinate_percent:training_category_match_superordinate_percent,names_to = "choice_type",values_to = "percent_chosen")

overall_accuracy_by_condition <- subj_test_accuracy_long %>%
  ungroup() %>%
  group_by(sample_group,number_training_images,current_category_training_level,choice_type) %>%
  summarize(
    N=n(),
    average_percent=mean(percent_chosen)
  ) %>%
  mutate(
    choice_type = str_remove(choice_type,"training_category_match_"),
    choice_type = str_remove(choice_type,"_percent")
  )

# looking at if 1- or 3-Item first has an effect
overall_accuracy_by_condition_round <- subj_test_accuracy_long %>%
  ungroup() %>%
  group_by(sample_group,round,number_training_images,current_category_training_level,choice_type) %>%
  summarize(
    N=n(),
    average_percent=mean(percent_chosen)
  ) %>%
  mutate(
    choice_type = str_remove(choice_type,"training_category_match_"),
    choice_type = str_remove(choice_type,"_percent")
  )

# accuracy based on training condition (N, I, B) and ground-truth (same level or 1 level up)

overall_accuracy_label_level_by_condition <- subj_test_accuracy_long %>%
  ungroup() %>%
  group_by(sample_group,number_training_images,current_category_training_level,current_category_label_level,choice_type) %>%
  summarize(
    N=n(),
    average_percent=mean(percent_chosen)
  ) %>%
  mutate(
    choice_type = str_remove(choice_type,"training_category_match_"),
    choice_type = str_remove(choice_type,"_percent")
  )

# again, looking at if 1- or 3-Item first has an effect on above accuracy

overall_accuracy_label_level_by_condition_round <- subj_test_accuracy_long %>%
  ungroup() %>%
  group_by(sample_group,round,number_training_images,current_category_training_level,current_category_label_level,choice_type) %>%
  summarize(
    N=n(),
    average_percent=mean(percent_chosen)
  ) %>%
  mutate(
    choice_type = str_remove(choice_type,"training_category_match_"),
    choice_type = str_remove(choice_type,"_percent")
  )


### longer test representation
subj_test_accuracy_all <- combined_test_array_options_clean %>%
  group_by(sample_group,participant,age_years,age_years_c,number_training_images,round,trial_counter,trial_type,current_category_training_level,current_category_label_level,current_category_kind,final_choice_array,total_number_correct_options_label,total_number_correct_options_training) %>%
  summarize(
    accuracy_training = mean(is_match_to_training, na.rm=TRUE),
    accuracy_label = mean(is_match_to_label,na.rm=TRUE),
    hit_rate_training = mean(hit_training,na.rm=TRUE),
    hit_rate_label = mean(hit_label,na.rm=TRUE),
    false_alarm_rate_training = mean(false_alarm_training,na.rm=TRUE),
    false_alarm_rate_label = mean(false_alarm_label,na.rm=TRUE)
  ) %>%
  mutate(
    hit_rate_training_adj= case_when(
      hit_rate_training==1 ~ 1 - 1/(2*total_number_correct_options_training),
      hit_rate_training==0 ~ 1/(2*total_number_correct_options_training),
      TRUE ~ hit_rate_training
    ),
    hit_rate_label_adj= case_when(
      hit_rate_label==1 ~ 1 - 1/(2*total_number_correct_options_label),
      hit_rate_label==0 ~ 1/(2*total_number_correct_options_label),
      TRUE ~ hit_rate_label
    ),
    false_alarm_rate_training_adj= case_when(
      false_alarm_rate_training==0 ~ 1/(2*total_number_correct_options_training),
      false_alarm_rate_training==1 ~ 1 - 1/(2*total_number_correct_options_training),
      TRUE ~ false_alarm_rate_training
    ),
    false_alarm_rate_label_adj= case_when(
      false_alarm_rate_label==0 ~ 1/(2*total_number_correct_options_label),
      false_alarm_rate_label==1 ~ 1 - 1/(2*total_number_correct_options_label),
      TRUE ~ false_alarm_rate_label
    )
  ) %>%
  mutate(
    dprime_training=qnorm(hit_rate_training_adj) - qnorm(false_alarm_rate_training_adj),
    dprime_label=qnorm(hit_rate_label_adj) - qnorm(false_alarm_rate_label_adj),
    c_training=-.5*(qnorm(hit_rate_training_adj) + qnorm(false_alarm_rate_training_adj)),
    c_label=-.5*(qnorm(hit_rate_label_adj) + qnorm(false_alarm_rate_label_adj)))

subj_test_accuracy_all <- subj_test_accuracy_all %>%
  left_join(combined_sampling_data)

# gives accuracy based on training level, ground-truth level, and if sampling was confirm/explore

#need fix sampling choice type in adults here
overall_accuracy_label_level_sampling_all <- subj_test_accuracy_all %>%
  ungroup() %>%
  group_by(sample_group,sampling_choice_type,current_category_training_level,current_category_label_level) %>%
  summarize(
    N=n(),
    average_dprime_training=mean(dprime_training),
    average_dprime_label=mean(dprime_label)
  ) 
```

# Sampling

## H1

Do learners flexibly shift their sampling choices depending on the training condition? 

```{r}
combined_sampling_data <- combined_sampling_data %>%
  mutate(
    sampled_category_level_kind_info_choice_order = case_when(
      sampled_category_level_kind_info == "outside_category" ~ "a_outside_category",
      sampled_category_level_kind_info == "sub" ~ "b_sub",
      sampled_category_level_kind_info == "bas" ~ "c_bas",
      sampled_category_level_kind_info == "sup" ~ "d_sup"
  ),
  current_category_training_level_order = case_when(
      current_category_training_level == "narrow" ~ "a_narrow",
      current_category_training_level == "intermediate" ~ "b_intermediate",
      current_category_training_level == "broad" ~ "c_broad"
  )
  )

combined_sampling_data_3_images_only <- combined_sampling_data %>%
  filter(number_training_images==3)
```

### Children
```{r}
#fit multinomial model
nnetFixedModelStr <- 'sampled_category_level_kind_info_choice_order ~ current_category_training_level_order'
nnetFixedFit_kids <-  multinom(as.formula(nnetFixedModelStr), filter(combined_sampling_data_3_images_only,sample_group=="children"), maxit=10000, abstol=1e-8, reltol=1e-10)
summary(nnetFixedFit_kids)
Anova(nnetFixedFit_kids,type="III")

# Alternative (equivalent) approach with mlogit
# reformat data for mlogit
mlogit_sampling_data_kids <-  mlogit.data(data=select(filter(combined_sampling_data_3_images_only,sample_group=="children"),participant,sampled_category_level_kind_info_choice_order,current_category_training_level_order,current_category_kind), choice='sampled_category_level_kind_info_choice_order', shape="wide", id.var='participant')

# specify model formula
mlogit_sampling_formula_baseline <- ' sampled_category_level_kind_info_choice_order ~ 0 | 1 | 0'
mlogit_sampling_formula_training <- 'sampled_category_level_kind_info_choice_order ~ 0 | current_category_training_level_order | 0'

# fit models
mlogit_sampling_baseline_kids <- mlogit(as.formula(mlogit_sampling_formula_baseline), data=mlogit_sampling_data_kids, panel=FALSE, iterlim=10000, tol = 1e-8)
print(summary(mlogit_sampling_baseline_kids))
mlogit_sampling_training_kids <- mlogit(as.formula(mlogit_sampling_formula_training), data=mlogit_sampling_data_kids, panel=FALSE, iterlim=10000, tol = 1e-8)
print(summary(mlogit_sampling_training_kids))

# overall test of condition (identical result to nnet method above)
lrtest(mlogit_sampling_baseline_kids,mlogit_sampling_training_kids)
```

### Adults
```{r}
#fit multinomial model
nnetFixedFit_adults <-  multinom(as.formula(nnetFixedModelStr), filter(combined_sampling_data_3_images_only,sample_group=="adults"), maxit=10000, abstol=1e-8, reltol=1e-10)
summary(nnetFixedFit_adults)
Anova(nnetFixedFit_adults,type="III")

# Alternative (equivalent) approach with mlogit
# reformat data for mlogit
mlogit_sampling_data_adults <-  mlogit.data(data=select(filter(combined_sampling_data_3_images_only,sample_group=="adults"),participant,sampled_category_level_kind_info_choice_order,current_category_training_level_order,current_category_kind), choice='sampled_category_level_kind_info_choice_order', shape="wide", id.var='participant')

# fit models
mlogit_sampling_baseline_adults <- mlogit(as.formula(mlogit_sampling_formula_baseline), data=mlogit_sampling_data_adults, panel=FALSE, iterlim=10000, tol = 1e-8)
print(summary(mlogit_sampling_baseline_adults))
mlogit_sampling_training_adults <- mlogit(as.formula(mlogit_sampling_formula_training), data=mlogit_sampling_data_adults, panel=FALSE, iterlim=10000, tol = 1e-8)
print(summary(mlogit_sampling_training_adults))

# overall test of condition (identical result to nnet method above)
lrtest(mlogit_sampling_baseline_adults,mlogit_sampling_training_adults)
```

### H1 across age (exploratory)

#### Children

```{r}
#fit multinomial model
nnetFixedModelStr_age <- 'sampled_category_level_kind_info_choice_order ~ current_category_training_level_order+age_years'
nnetFixedFit_age <-  multinom(as.formula(nnetFixedModelStr_age), filter(combined_sampling_data_3_images_only,sample_group=="children"), maxit=10000, abstol=1e-8, reltol=1e-10)
summary(nnetFixedFit_age)
Anova(nnetFixedFit_age,type="III")
```

#### Interaction with Training Condition

```{r}
#fit multinomial model
nnetFixedModelStr_age <- 'sampled_category_level_kind_info_choice_order ~ current_category_training_level_order*age_years'
nnetFixedFit_age <-  multinom(as.formula(nnetFixedModelStr_age), filter(combined_sampling_data_3_images_only,sample_group=="children"), maxit=10000, abstol=1e-8, reltol=1e-10)
summary(nnetFixedFit_age)
Anova(nnetFixedFit_age,type="III")
```

No significant interaction between age and training condition

#### Visualize the age effect

```{r}
combined_sampling_data <- combined_sampling_data |> 
  mutate(
    sample_subordinate_choice = ifelse(sampled_category_level_kind_info_choice_order == "b_sub", 1,0),
    sample_basic_choice = ifelse(sampled_category_level_kind_info_choice_order == "c_bas", 1,0),
    sample_superordinate_choice = ifelse(sampled_category_level_kind_info_choice_order == "d_sup", 1,0),
    sample_outside_choice = ifelse(sampled_category_level_kind_info_choice_order == "a_outside_category", 1,0)
  )

p1 <- combined_sampling_data %>%
  filter(number_training_images==3 & sample_group=="children") %>%
  ggplot(aes(age_years,sample_subordinate_choice))+
  geom_smooth(aes(color=current_category_training_level),method="lm",se=F,alpha=0.5)+
  geom_smooth(method="lm")
p2 <- combined_sampling_data %>%
  filter(number_training_images==3 & sample_group=="children") %>%
  ggplot(aes(age_years,sample_basic_choice))+
  geom_smooth(aes(color=current_category_training_level),method="lm",se=F,alpha=0.5)+
  geom_smooth(method="lm")
p3 <- combined_sampling_data %>%
  filter(number_training_images==3 & sample_group=="children") %>%
  ggplot(aes(age_years,sample_superordinate_choice))+
  geom_smooth(aes(color=current_category_training_level),method="lm",se=F,alpha=0.5)+
  geom_smooth(method="lm")
p4 <- combined_sampling_data %>%
  filter(number_training_images==3 & sample_group=="children") %>%
  ggplot(aes(age_years,sample_outside_choice))+
  geom_smooth(aes(color=current_category_training_level),method="lm",se=F,alpha=0.5)+
  geom_smooth(method="lm")

(p1+p2)/(p3+p4)

```

#### Follow-up investigation of choices

```{r}
m <- glmer(sample_subordinate_choice~age_years_c+(1|participant),data=filter(combined_sampling_data,number_training_images==3 & sample_group=="children"),family=binomial)
summary(m)
m <- glmer(sample_basic_choice~age_years_c+(1|participant),data=filter(combined_sampling_data,number_training_images==3 & sample_group=="children"),family=binomial)
summary(m)
m <- glmer(sample_superordinate_choice~age_years_c+(1|participant),data=filter(combined_sampling_data,number_training_images==3 & sample_group=="children"),family=binomial)
summary(m)
m <- glmer(sample_outside_choice~age_years_c+(1|participant),data=filter(combined_sampling_data,number_training_images==3 & sample_group=="children"),family=binomial)
summary(m)
```


## H2 1-Narrow vs. 3-Narrow

### Children

```{r}
#filter relevant conditions
combined_sampling_data_1_vs_3 <- combined_sampling_data %>%
  filter(current_category_training_level=="narrow") %>%
  mutate(
    number_training_images_c=(number_training_images-2)/2
  )

#fit multinomial model
nnetFixedModelStr_h2a <- 'sampled_category_level_kind_info_choice_order ~ number_training_images_c'
nnetFixedFit_h2a_kids <-  multinom(as.formula(nnetFixedModelStr_h2a), filter(combined_sampling_data_1_vs_3,sample_group=="children"), maxit=10000, abstol=1e-8, reltol=1e-10)
summary(nnetFixedFit_h2a_kids)
Anova(nnetFixedFit_h2a_kids,type="III")
```

### Adults

```{r}
nnetFixedFit_h2a_adults <-  multinom(as.formula(nnetFixedModelStr_h2a), filter(combined_sampling_data_1_vs_3,sample_group=="adults"), maxit=10000, abstol=1e-8, reltol=1e-10)
summary(nnetFixedFit_h2a_adults)
Anova(nnetFixedFit_h2a_adults,type="III")
```

### H2A: 1-Narrow vs. 3-Narrow across age (exploratory)

```{r}
#fit multinomial model
nnetFixedModelStr_h2a_age <- 'sampled_category_level_kind_info_choice_order ~ number_training_images_c*age_years'
nnetFixedFit_h2a_age <-  multinom(as.formula(nnetFixedModelStr_h2a_age), filter(combined_sampling_data_1_vs_3,sample_group=="children"), maxit=10000, abstol=1e-8, reltol=1e-10)
summary(nnetFixedFit_h2a_age)
Anova(nnetFixedFit_h2a_age,type="III")
```

### Plot

```{r}
combined_sampling_data$sampled_category_level_kind_info_ord <- factor(combined_sampling_data$sampled_category_level_kind_info,                                                           levels=c("sub","bas","sup","outside_category"),
                                                                  labels=c("subordinate","basic","superordinate","outside category"))

combined_sampling_data <- combined_sampling_data %>%
  mutate(training_condition = case_when(
    number_training_images == 1 ~ "1-Item",
    TRUE ~ paste0("3-Item ", stringr::str_to_title(current_category_training_level))
  )) 
combined_sampling_data$training_condition_ord <- factor(combined_sampling_data$training_condition,levels=c("1-Item","3-Item Narrow", "3-Item Intermediate","3-Item Broad"))
  
# combined_sampling_data$current_category_training_level_ord <- factor(combined_sampling_data$current_category_training_level,levels=c("narrow","intermediate","broad"))

ggplot(combined_sampling_data,aes(training_condition_ord,fill=sampled_category_level_kind_info_ord, pattern=sampling_choice_type))+
  geom_bar_pattern(position="fill",
                   color = "black", 
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.2,
                   pattern_spacing = 0.025,
                   pattern_key_scale_factor = 1)+
  scale_fill_brewer(name="Sampling Choice",palette="RdYlBu")+
  scale_pattern_manual(name = 
                         "Choice Type",values = c(explore = "none", confirm = "circle")) +
  xlab("Training Condition")+
  ylab("Proportion of Sampling Choices")+
  facet_wrap(~sample_group)+
  theme_cowplot(font_size=14)+
  theme(axis.title = element_text(face="bold", size=12),axis.text.x  = element_text(angle=90, hjust=1,vjust=0.4))+
  guides(pattern = guide_legend(override.aes = list(fill = "white"),order=2),
         fill = guide_legend(override.aes = list(pattern = "none"),order=1))
ggsave(here(figure_path,"kitty-act-sampling.png"),width=6,height=7)

## Sampling Choices - individual bars
combined_sampling_data_long_structure <- expand.grid(
  participant=unique(combined_sampling_data$participant),
  trial_counter=seq(1,6),
  sampling_choice_type = c("subordinate","basic","superordinate","outside category")
)
combined_sampling_data_long <-  combined_sampling_data %>%
  group_by(participant,sample_group,age_years,age_group,number_training_images,trial_counter, current_category_training_level) %>%
  summarize(sampling_response = sampled_category_level_kind_info_ord) %>%
  arrange(participant,trial_counter)
combined_sampling_data_long_structure <- combined_sampling_data_long_structure %>%
  left_join(combined_sampling_data_long) %>%
  mutate(
    sampling_choice_chosen = case_when(
      sampling_response == sampling_choice_type ~ 1,
      TRUE ~ 0
    )
  )

combined_sampling_data_long_structure_summarized <- combined_sampling_data_long_structure %>%
  group_by(sample_group,number_training_images,current_category_training_level, sampling_choice_type) %>%
  summarize(
    N=n(),
    sampling_response_avg=mean(sampling_choice_chosen,na.rm=TRUE),
    sampling_response_total=sum(sampling_choice_chosen,na.rm=TRUE),
    sampling_response_binom_lower=binom.test(sampling_response_total,N)$conf.int[1],
    sampling_response_binom_upper=binom.test(sampling_response_total,N)$conf.int[2],
  )
combined_sampling_data_long_structure_summarized$current_category_training_level_ord <- factor(combined_sampling_data_long_structure_summarized$current_category_training_level,levels=c("narrow","intermediate","broad"))


ggplot(combined_sampling_data_long_structure_summarized,aes(current_category_training_level_ord,sampling_response_avg, group=sampling_choice_type,fill=sampling_choice_type))+
  geom_errorbar(aes(ymin=sampling_response_binom_lower, ymax=sampling_response_binom_upper),width=0.3, color="black",position=position_dodge(width=0.9))+
  geom_bar(stat="identity",position=position_dodge())+
  #theme_cowplot(font_size=30)+
  scale_fill_brewer(name="Sampling Choice Type",palette="RdYlBu")+
  scale_color_brewer(name="Sampling Choice Type",palette="RdYlBu")+
  xlab("Training Condition")+
  ylab("Proportion of Sampling Choices")+
  facet_wrap(~number_training_images+sample_group)
```

## Sampling by Age

### Plot

```{r fig.width=10, fig.height=4}
# summarizing
combined_sampling_data_ages_summarized <- combined_sampling_data_long_structure %>%
  group_by(age_group, 
           number_training_images,
           current_category_training_level,
           sampling_choice_type) %>% 
  summarize(
    N=n(),
    sampling_response_avg=mean(sampling_choice_chosen,na.rm=TRUE),
    sampling_response_total=sum(sampling_choice_chosen,na.rm=TRUE),
    sampling_response_binom_lower=binom.test(sampling_response_total,N)$conf.int[1],
    sampling_response_binom_upper=binom.test(sampling_response_total,N)$conf.int[2],
  ) 

combined_sampling_data_ages_summarized$current_category_training_level <- factor(combined_sampling_data_ages_summarized$current_category_training_level,levels=c("narrow","intermediate","broad"))

combined_sampling_data_ages_summarized %>% filter(number_training_images == 1) %>% 
  ggplot(aes(x = age_group, 
             y = sampling_response_avg, 
             color = sampling_choice_type)) + 
  geom_point() +
  geom_line()

combined_sampling_data_ages_summarized %>% filter(number_training_images == 3) %>% 
  ggplot(aes(x = age_group, 
             y = sampling_response_avg, 
             color = sampling_choice_type)) + 
  geom_point() +
  geom_line() + 
  facet_wrap(. ~ current_category_training_level, ncol = 3)
```

Continuous plot

```{r}
ggplot(combined_sampling_data_long_structure,aes(age_years,sampling_choice_chosen,color=sampling_choice_type))+
  geom_smooth(method="loess")+
  facet_wrap(~number_training_images+current_category_training_level)
```

## H3: confirmatory/ exploratory choice

```{r}
combined_sampling_data <- combined_sampling_data %>%
  mutate(is_exploratory=ifelse(sampling_choice_type=="explore",1,0)) %>%
  mutate(
    sample_group_c = ifelse(sample_group=="children",-0.5,0.5)
  ) %>%
  mutate(
    chance_level = case_when(
      training_condition == "1-Item" ~ 0.75,
      training_condition == "3-Item Narrow" ~ 0.75,
      training_condition == "3-Item Intermediate" ~ 0.5,
      training_condition == "3-Item Broad" ~ 0.25
    )
  )
#more complex random effects structure leads to singular fit/ non-convergence
m <- glmer(is_exploratory~ offset(logit(chance_level))+ sample_group_c+training_condition+(1|participant),data=combined_sampling_data,family="binomial")
summary(m)
Anova(m,type="III")

#children below-chance?
m <- glmer(is_exploratory~ offset(logit(chance_level))+(1|participant),data=filter(combined_sampling_data,sample_group=="children"),family="binomial")
summary(m)
#adults below chance?
m <- glmer(is_exploratory~ offset(logit(chance_level))+(1|participant),data=filter(combined_sampling_data,sample_group=="adults"),family="binomial")
summary(m)
```

### Exploratory: Interaction

```{r}
m <- glmer(is_exploratory~ sample_group_c*training_condition+(1|participant),data=combined_sampling_data,family="binomial")
summary(m)
Anova(m,type="III")
```

```{r}
combined_sampling_data <- combined_sampling_data %>%
  mutate(training_condition = fct_relevel(training_condition, "1-Item","3-Item Narrow","3-Item Intermediate","3-Item Broad"))
p1 <- ggplot(combined_sampling_data,aes(age_years,is_exploratory, color=training_condition))+
  geom_smooth(method="lm",se=F)+
  geom_smooth(method="lm",se=T,color="black")+
  #facet_wrap(~training_condition)+
  scale_color_brewer(palette="RdYlGn")+
  theme_cowplot()+
  #theme(legend.position="none")+
  xlab("Age (years)")+
  ylab("Proportion Exploratory Choices")+
  ylim(0,1)
p1
#summarize
subj_sampling_exploratory <- combined_sampling_data %>%
  group_by(participant,sample_group,age_group,age_years,training_condition) %>%
  summarize(
    exploratory_choice = mean(is_exploratory)
  )

overall_sampling_exploratory <- subj_sampling_exploratory %>%
  group_by(sample_group,training_condition) %>%
  summarize(
    N=n(),
    avg_exploratory_choice = mean(exploratory_choice),
    sd = sd(exploratory_choice,na.rm=T)/sqrt(N),
    se = sd(exploratory_choice,na.rm=T)/sqrt(N),
    ci=qt(0.975, N-1)*se,
  ) %>%
  mutate(chance_level = case_when(
    training_condition == "1-Item" ~ 0.75,
    training_condition == "3-Item Narrow" ~ 0.75,
    training_condition == "3-Item Intermediate" ~ 0.5,
    training_condition == "3-Item Broad" ~ 0.25
  ))

p2 <- ggplot(overall_sampling_exploratory,aes(training_condition,avg_exploratory_choice, color=training_condition,fill=training_condition))+
  geom_bar(stat="identity")+
  geom_errorbar(aes(ymin=avg_exploratory_choice-ci,ymax=avg_exploratory_choice+ci),width=0)+
  facet_wrap(~sample_group)+
  theme(legend.position="none")+
  xlab("Training Condition")+
  ylab("Proportion Exploratory Choices")+
  ylim(0,1)+
  annotate("segment",x=0.5,xend = 1.5,y = 0.75,linetype="dashed")+
  annotate("segment",x=1.5,xend = 2.5,y = 0.75,linetype="dashed")+
  annotate("segment",x=2.5,xend = 3.5,y = 0.5,linetype="dashed")+
  annotate("segment",x=3.5,xend = 4.5,y = 0.25,linetype="dashed")+
  theme(axis.title = element_text(face="bold"),axis.text.x  = element_text(angle=90, hjust=1,vjust=0.4))
p2
p1+p2
```

### Exploratory

#### investigate the proportion of exploratory choices

```{r}
subj_exploratory <- combined_sampling_data %>%
  mutate(
    age_bins=case_when(
      age_years<5.5 ~ 5,
      age_years<6.5 ~ 6,
      age_years<7.5 ~ 7,
      age_years<8.5 ~ 8,
      age_years<9.5 ~ 9,
      TRUE ~ NA
      
    )
  ) %>%
  group_by(participant,age_bins) %>%
  summarize(
    N=n(),
    prop_exploratory=mean(is_exploratory)
  )

#exploratory averages by age group
overall_exploratory_age_group <- subj_exploratory %>%
  group_by(age_bins) %>%
  summarize(
    N=n(),
    mean_explore=mean(prop_exploratory),
    sd(prop_exploratory,na.rm=T)/sqrt(N),
    se = sd(prop_exploratory,na.rm=T)/sqrt(N),
    ci=qt(0.975, N-1)*se,
    lower_se = mean_explore-se,
    upper_se = mean_explore+se,
    lower_ci=mean_explore-ci,
    upper_ci=mean_explore+ci,
  )

#model
m <- glmer(is_exploratory~ age_years_c*training_condition+(1|participant),data=combined_sampling_data,family="binomial")
summary(m)
Anova(m,type="III") 

# New data for prediction
# predicted_data <- expand.grid(
#   age_years_c = seq(min(combined_sampling_data$age_years_c,na.rm=T), max(combined_sampling_data$age_years_c,na.rm=T), length.out = 100),
#   training_condition = unique(combined_sampling_data$training_condition)) %>%
#   mutate(
#     age_years=age_years_c+mean(kid_participant_info$age_years)
#   )
# 
# # Predicting probabilities
# predicted_data$prob <- predict(m, newdata = new_data, type = "response",re.form=NA)
# 
# summarized_predicted_probs <- predicted_data %>%
#   group_by(age_years_c,age_years) %>%
#   summarize(
#     average_prob = mean(prob)
#   )

p2 <- ggplot(combined_sampling_data,aes(age_years,is_exploratory))+
  #geom_hline(yintercept=0.5,linetype="dashed")+
  geom_smooth(method="glm", method.args = list(family = "binomial"),color="black")+
  geom_errorbar(data=overall_exploratory_age_group,aes(age_bins,y=mean_explore,ymin=lower_se,ymax=upper_se),width=0,color="#0A5C36")+
  geom_point(data=overall_exploratory_age_group,aes(age_bins,mean_explore),color="#0A5C36",size=3)+
  ylab("Proportion Exploratory Choices")+
  xlab("Age (in years)")+
  theme_cowplot(font_size=12)+
  theme(axis.title = element_text(face="bold", size=14),
        #axis.text.x  = element_text(angle=90, hjust=1,vjust=0.4)
        )#+
  #ylim(0,1)

p2
ggsave(here(figure_path,"kitty-act-sampling-by-age.png"),width=6,height=4)
 

ggplot(combined_sampling_data,aes(age_years,is_exploratory, color=training_condition))+
  geom_smooth(method="lm",se=F)+
  geom_smooth(method="lm",color="black")
  
```

# Test

## Plot

```{r}
## Test Plot
subj_test_prop <- combined_test_array_options_clean %>%
  mutate(training_condition = case_when(
    number_training_images == 1 ~ "1-Item",
    TRUE ~ paste0("3-Item ", stringr::str_to_title(current_category_training_level))
  )) %>%
  ungroup() %>%
  group_by(sample_group,participant,age_years,age_years_c,age_group,number_training_images,current_category_training_level,training_condition,current_category_label_level,current_category_kind) %>%
  summarize(
    N_subordinate = sum(test_image_type=="subordinate" & test_image_match_category==1),
    prop_subordinate = sum(test_image_type=="subordinate" & test_image_match_category==1 & is_chosen == 1)/sum(test_image_type=="subordinate" & test_image_match_category==1),
    N_basic = sum(test_image_type=="basic" & test_image_match_category==1),
    prop_basic = sum(test_image_type=="basic" & test_image_match_category==1 & is_chosen == 1)/sum(test_image_type=="basic" & test_image_match_category==1),
    N_superordinate = sum(test_image_type=="superordinate" & test_image_match_category==1),
    prop_superordinate = sum(test_image_type=="superordinate" & test_image_match_category==1 & is_chosen == 1)/sum(test_image_type=="superordinate" & test_image_match_category==1)
  )

subj_test_prop_long <- subj_test_prop %>%
  pivot_longer(N_subordinate:prop_superordinate,names_to=c(".value","choice_type"),names_sep="\\_")

overall_test_prop <- subj_test_prop %>%
  group_by(sample_group,training_condition,number_training_images,current_category_training_level) %>%
  summarize(
    N=n(),
    subordinate_percent = mean(prop_subordinate),
    basic_percent = mean(prop_basic),
    superordinate_percent = mean(prop_superordinate)
  )

overall_test_prop_long <- subj_test_prop_long %>%
  group_by(sample_group,training_condition,number_training_images,current_category_training_level,choice_type) %>%
  summarize(
    N=n(),
    avg_prop = mean(prop),
    prop_ci=qt(0.975, N-1)*sd(prop,na.rm=T)/sqrt(N),
    prop_lower_ci=avg_prop-prop_ci,
    prop_upper_ci=avg_prop+prop_ci,
  )
overall_test_prop_long$choice_type_ord <- factor(overall_test_prop_long$choice_type,levels=c("subordinate","basic","superordinate"))
overall_test_prop_long$training_condition_ord <- factor(overall_test_prop_long$training_condition,levels=c("1-Item","3-Item Narrow", "3-Item Intermediate","3-Item Broad"))

p1 <- ggplot(filter(overall_test_prop_long,sample_group=="children"),aes(choice_type_ord,avg_prop,fill=choice_type_ord))+
  geom_bar(stat="identity")+
  geom_errorbar(aes(ymin=prop_lower_ci,ymax=prop_upper_ci),width=0.1)+
  facet_wrap(~training_condition_ord)+
  theme_cowplot(font_size=12)+
  scale_fill_manual(
    name="Test Choice Type",
    values=c("#d7191c","#fdae61","#abd9e9"))+
  xlab("Test Choice Type")+
  ylab("Average Proportion\nof Test Choices")+
  theme(legend.position="none")+
  theme(axis.title = element_text(face="bold", size=14),
        axis.text.x  = element_text(angle=90, hjust=1,vjust=0.4)
        )+
  ggtitle("CHILDREN") +
  theme(plot.title = element_text(hjust = 0.5))
p2 <- ggplot(filter(overall_test_prop_long,sample_group=="adults"),aes(choice_type_ord,avg_prop,fill=choice_type_ord))+
  geom_bar(stat="identity")+
  geom_errorbar(aes(ymin=prop_lower_ci,ymax=prop_upper_ci),width=0.1)+
  facet_wrap(~training_condition_ord)+
  theme_cowplot(font_size=12)+
  scale_fill_manual(
    name="Test Choice Type",
    values=c("#d7191c","#fdae61","#abd9e9"))+
  xlab("Test Choice Type")+
  ylab("Average Proportion\nof Test Choices")+
  theme(legend.position="none")+
  theme(axis.title = element_text(face="bold", size=14),
        axis.text.x  = element_text(angle=90, hjust=1,vjust=0.4)
        )+
  ggtitle("ADULTS") +
  theme(plot.title = element_text(hjust = 0.5))
p2/p1+plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text(size = 20))
ggsave(here(figure_path,"kitty-act-test.png"),width=6,height=12)
  
```

## H4: Test Choices

Training condition modulated participantsâ€™ choices at test (Proportion choices)

### Children

```{r}
# fit individual (g)lmer models
#
## subordinate choices
#singular fit but does not appear to affect estimates - keeping category random intercept for consistency
m_sub <- glmer(prop_subordinate~training_condition+(1|participant)+(1|current_category_kind),data=filter(subj_test_prop,sample_group=="children"),family=binomial)
summary(m_sub)
Anova(m_sub,type="III")

## basic choices
m_bas <- glmer(prop_basic~training_condition+(1|participant)+(1|current_category_kind),data=filter(subj_test_prop,sample_group=="children"),family=binomial)
summary(m_bas)
Anova(m_bas,type="III")

## superordinate choices
m_sup <- lmer(prop_superordinate~training_condition+(1|participant)+(1|current_category_kind),data=filter(subj_test_prop,sample_group=="children"))
summary(m_sup)
Anova(m_sup,type="III")
```

### Adults

```{r}
# fit individual lmer models
## subordinate choices
m_sub <- lmer(prop_subordinate~training_condition+(1|participant)+(1|current_category_kind),data=filter(subj_test_prop,sample_group=="adults"))
summary(m_sub)
Anova(m_sub,type="III")

## basic choices
m_bas <- lmer(prop_basic~training_condition+(1|participant)+(1|current_category_kind),data=filter(subj_test_prop,sample_group=="adults"))
summary(m_bas)
Anova(m_bas,type="III")

## superordinate choices
m_sup <- lmer(prop_superordinate~training_condition+(1|participant)+(1|current_category_kind),data=filter(subj_test_prop,sample_group=="adults"))
summary(m_sup)
Anova(m_sup,type="III")
```

### Exploratory: Interaction with Sample Group

```{r}
## subordinate choices
m_sub <- glmer(prop_subordinate~training_condition*sample_group+(1|participant)+(1|current_category_kind),data=subj_test_prop,family=binomial)
summary(m_sub)
Anova(m_sub,type="III")

## basic choices
m_bas <- glmer(prop_basic~training_condition*sample_group+(1|participant)+(1|current_category_kind),data=subj_test_prop,family=binomial)
summary(m_bas)
Anova(m_bas,type="III")

## superordinate choices
m_sup <- lmer(prop_superordinate~training_condition*sample_group+(1|participant)+(1|current_category_kind),data=subj_test_prop)
summary(m_sup)
Anova(m_sup,type="III")
```


## H5: Proportion basic-level choices

### Children

#### Preregistered

```{r}
#filter to relevant data
basic_test_choices <- combined_test_array_options_clean %>%
  filter(test_image_type == "basic" & test_image_match_category==1) %>%
  mutate(number_training_images_c=(number_training_images-2)/2)

m <- glmer(is_chosen ~ number_training_images_c+(1|participant)+(1|current_category_kind),data=filter(basic_test_choices,sample_group=="children"&current_category_training_level=="narrow"),family="binomial")
summary(m)
```

Exploratory: No interaction with age

```{r}
m <- glmer(is_chosen ~ number_training_images_c*age_years_c+(1|participant)+(1|current_category_kind),data=filter(basic_test_choices,sample_group=="children"&current_category_training_level=="narrow"),family="binomial")
summary(m)
```

```{r}
#equivalent:
subj_test_prop <- subj_test_prop %>%
  mutate(number_training_images_c=(number_training_images-2)/2)

m <- glmer(prop_basic ~ number_training_images_c+(1|participant)+(1|current_category_kind),data=filter(subj_test_prop,sample_group=="children"&current_category_training_level=="narrow"),family="binomial")
summary(m)
#replicates the basic Xu/ Tenenbaum effect
```

### Adults

```{r}
m <- glmer(is_chosen ~ number_training_images_c+(1|participant)+(1|current_category_kind),data=filter(basic_test_choices,sample_group=="adults"&current_category_training_level=="narrow"),family="binomial")
summary(m)
```

### Exploratory: 1-3 vs. 3-1 order

#### Children

```{r}
basic_test_choices <- basic_test_choices %>%
  mutate(
    training_num_order = ifelse(number_training_image_order_vector =="[1,3]","1-3","3-1"),
    training_num_order_numeric = ifelse(number_training_image_order_vector =="[1,3]",0,1),
    training_num_order_numeric_c = training_num_order_numeric-0.5
  )

m <- glmer(is_chosen ~ number_training_images_c*training_num_order_numeric_c+(1|participant)+(1|current_category_kind),data=filter(basic_test_choices,sample_group=="children"&current_category_training_level=="narrow"),family="binomial")
summary(m)
```

#### Adults

```{r}
m <- glmer(is_chosen ~ number_training_images_c*training_num_order_numeric_c+(1|participant)+(1|current_category_kind),data=filter(basic_test_choices,sample_group=="adults"&current_category_training_level=="narrow"),family="binomial")
summary(m)
```

#### Plot

```{r}
ggplot(filter(basic_test_choices,current_category_training_level=="narrow"),aes(number_training_images_c,is_chosen))+
  geom_smooth(method="lm")+
  facet_wrap(~training_num_order+sample_group)
```


## H6: No interaction between children and adults

```{r}
m <- glmer(is_chosen ~ number_training_images_c*sample_group+(1|participant)+(1|current_category_kind),data=filter(basic_test_choices,current_category_training_level=="narrow"),family="binomial")
summary(m)
Anova(m, type="III")
```
